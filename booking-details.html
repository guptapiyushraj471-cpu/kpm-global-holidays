<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking Details | KPM Global Holiday</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="View individual booking details for KPM Global Holidays." />
  <link rel="stylesheet" href="styles.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;700&display=swap" rel="stylesheet">

  <style>
    /* AI-themed Booking Details Page Styles */
    :root {
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-accent: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --shadow-soft: 0 4px 24px rgba(0, 0, 0, 0.06);
      --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.08);
      --shadow-large: 0 16px 48px rgba(0, 0, 0, 0.1);
    }

    .nav-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }

    .logo,
    .footer-logo {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .logo-img {
      height: 32px;
      width: auto;
      display: block;
      object-fit: contain;
    }

    .footer-logo .logo-img {
      height: 32px;
    }

    .booking-details-page {
      min-height: 100vh;
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
    }

    /* Hero */
    .booking-details-hero {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 28px 0 40px;
      position: relative;
      overflow: hidden;
    }

    .booking-details-hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
      opacity: 0.3;
    }

    .booking-details-hero-content {
      position: relative;
      z-index: 1;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 16px;
    }

    .breadcrumb a {
      color: rgba(255, 255, 255, 0.9);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .breadcrumb a:hover {
      color: #ffffff;
    }

    .booking-details-hero h1 {
      color: #ffffff;
      font-size: 30px;
      font-weight: 700;
      margin: 0 0 8px;
      line-height: 1.2;
    }

    .booking-details-hero p {
      color: rgba(255, 255, 255, 0.9);
      font-size: 15px;
      margin: 0;
    }

    .booking-details-content {
      padding: 0 0 60px;
      margin-top: -20px;
      position: relative;
      z-index: 2;
    }

    .booking-layout {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 24px;
      align-items: flex-start;
    }

    .booking-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 28px;
      box-shadow: var(--shadow-large);
      border: 1px solid rgba(148, 163, 184, 0.1);
    }

    .booking-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid rgba(148, 163, 184, 0.1);
    }

    .booking-card-header h2 {
      font-size: 22px;
      font-weight: 600;
      color: #0f172a;
      margin: 0 0 6px;
    }

    .booking-card-header p {
      font-size: 14px;
      color: #64748b;
      margin: 0;
    }

    .badge-booking {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 500;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
      border: 1px solid rgba(102, 126, 234, 0.3);
      color: #667eea;
    }

    .booking-meta-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px 24px;
    }

    .meta-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .meta-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #64748b;
      font-weight: 500;
    }

    .meta-value {
      font-size: 15px;
      font-weight: 500;
      color: #0f172a;
    }

    .meta-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid rgba(148, 163, 184, 0.1);
    }

    .meta-section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #64748b;
      font-weight: 500;
      margin-bottom: 12px;
    }

    .meta-section-content {
      font-size: 14px;
      line-height: 1.6;
      color: #475569;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-pill::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 999px;
    }
    .status-new {
      background: rgba(245, 158, 11, 0.1);
      color: #92400e;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .status-new::before {
      background: #f59e0b;
    }
    .status-confirmed {
      background: rgba(34, 197, 94, 0.1);
      color: #15803d;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .status-confirmed::before {
      background: #22c55e;
    }
    .status-cancelled {
      background: rgba(239, 68, 68, 0.1);
      color: #991b1b;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    .status-cancelled::before {
      background: #ef4444;
    }

    .actions-card {
      background: #ffffff;
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow-medium);
      border: 1px solid rgba(148, 163, 184, 0.1);
      position: sticky;
      top: 90px;
    }

    .actions-card h2 {
      font-size: 20px;
      font-weight: 600;
      color: #0f172a;
      margin: 0 0 8px;
    }

    .actions-card-subtitle {
      font-size: 14px;
      color: #64748b;
      margin: 0 0 20px;
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .pill-btn-main {
      width: 100%;
      padding: 12px 20px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: #ffffff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #475569;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .pill-btn-main:hover:not([disabled]) {
      border-color: #667eea;
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
      transform: translateY(-1px);
      box-shadow: var(--shadow-soft);
    }

    .pill-btn-main[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pill-btn-main.primary {
      background: var(--gradient-primary);
      color: #ffffff;
      border-color: transparent;
    }

    .pill-btn-main.primary:hover:not([disabled]) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
      color: #ffffff;
    }

    .actions-info {
      margin-top: 16px;
      padding: 14px;
      background: rgba(102, 126, 234, 0.05);
      border: 1px solid rgba(102, 126, 234, 0.15);
      border-radius: 10px;
      font-size: 13px;
      color: #475569;
      line-height: 1.5;
    }

    .status-timeline {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      border: 1px solid rgba(102, 126, 234, 0.15);
      border-radius: 12px;
      padding: 18px;
      margin-top: 20px;
    }

    .timeline-title {
      font-size: 14px;
      font-weight: 600;
      color: #667eea;
      margin: 0 0 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 12px;
    }

    .timeline-item:last-child {
      margin-bottom: 0;
    }

    .timeline-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      color: #ffffff;
    }

    .timeline-content h4 {
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      margin: 0 0 4px;
    }

    .timeline-content p {
      font-size: 13px;
      color: #64748b;
      margin: 0;
    }

    @media (max-width: 900px) {
      .booking-layout {
        grid-template-columns: 1fr;
      }
      .booking-meta-grid {
        grid-template-columns: 1fr;
      }
      .actions-card {
        position: static;
        top: auto;
      }
    }
  </style>
</head>
<body class="theme-dark booking-details-page">
  <!-- Top utility bar -->
  <div class="top-bar" role="region" aria-label="Top utility">
    <div class="container top-bar-inner">
      <div class="top-left">
        <span class="top-pill">KPM Global Holidays</span>
        <span class="top-text">Booking details</span>
      </div>
      <div class="top-right">
        <button class="top-link" type="button" onclick="window.location.href='admin.html'">
          ‚Üê Back to admin
        </button>
        <button class="btn-outline small" type="button" onclick="window.location.href='index.html'">
          Website
        </button>
      </div>
    </div>
  </div>

  <!-- Main navigation -->
  <header class="site-header" role="banner">
    <div class="container nav-inner">
      <a class="logo" href="admin.html" aria-label="KPM Global Holidays Admin Home">
        <img src="images/Logo-KPM Global  Holiday.png" alt="KPM Global Holidays Logo" class="logo-img" />
        KPM Global<span> Admin</span>
      </a>

      <nav class="nav-links" id="primaryNav" aria-label="Admin navigation">
        <a href="admin.html#packages-admin">Packages</a>
        <a href="admin.html#orders-admin">Orders</a>
        <a href="admin.html#stats-admin">Stats</a>
      </nav>

      <button class="btn-primary nav-cta" type="button" onclick="window.location.href='index.html'">
        Go to Website
      </button>

      <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation" aria-expanded="false" aria-controls="primaryNav">
        <span></span>
        <span></span>
      </button>
    </div>
  </header>

  <!-- Hero Section -->
  <div class="booking-details-hero">
    <div class="container">
      <div class="booking-details-hero-content">
        <div class="breadcrumb">
          <a href="admin.html">Admin</a>
          <span>‚Ä∫</span>
          <a href="admin.html#orders-admin">Orders</a>
          <span>‚Ä∫</span>
          <span>Booking Details</span>
        </div>
        <h1 id="booking-title">Booking details</h1>
        <p id="booking-subtitle">Loading booking details...</p>
      </div>
    </div>
  </div>

  <!-- Booking details main -->
  <main class="booking-details-content" aria-label="Booking details">
    <div class="container">
      <div class="booking-layout">
        
        <!-- Left: Main Booking Info -->
        <div>
          <div class="booking-card">
            <div class="booking-card-header">
              <div>
                <h2>Booking Information</h2>
                <p>Complete traveler and trip details</p>
              </div>
              <div>
                <span class="badge-booking" id="booking-id-label">
                  üìã Loading‚Ä¶
                </span>
              </div>
            </div>

            <div class="booking-meta-grid" id="booking-meta">
              <div class="meta-item">
                <div class="meta-label">Package</div>
                <div class="meta-value" id="meta-package">‚Äì</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Destination</div>
                <div class="meta-value" id="meta-destination">‚Äì</div>
              </div>

              <div class="meta-item">
                <div class="meta-label">Traveler name</div>
                <div class="meta-value" id="meta-name">‚Äì</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Email</div>
                <div class="meta-value" id="meta-email">‚Äì</div>
              </div>

              <div class="meta-item">
                <div class="meta-label">Phone / WhatsApp</div>
                <div class="meta-value" id="meta-phone">‚Äì</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Travel dates</div>
                <div class="meta-value" id="meta-dates">‚Äì</div>
              </div>

              <div class="meta-item">
                <div class="meta-label">Guests</div>
                <div class="meta-value" id="meta-guests">‚Äì</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Created at</div>
                <div class="meta-value" id="meta-created">‚Äì</div>
              </div>

              <div class="meta-item">
                <div class="meta-label">Status</div>
                <div class="meta-value">
                  <span id="meta-status-pill" class="status-pill status-new">New</span>
                </div>
              </div>
            </div>

            <div class="meta-section">
              <div class="meta-section-title">Special requests / preferences</div>
              <p id="meta-preferences" class="meta-section-content">
                ‚Äì
              </p>
            </div>

            <div class="status-timeline">
              <div class="timeline-title">
                <span>üìä</span>
                <span>Booking Timeline</span>
              </div>
              <div class="timeline-item">
                <div class="timeline-icon">‚úì</div>
                <div class="timeline-content">
                  <h4>Booking Received</h4>
                  <p id="timeline-created">Customer submitted booking request.</p>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-icon">‚è≥</div>
                <div class="timeline-content">
                  <h4>Current Status</h4>
                  <p id="timeline-status">Awaiting admin review and confirmation.</p>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-icon">üìß</div>
                <div class="timeline-content">
                  <h4>Next Step</h4>
                  <p>Use quick actions to contact traveler and share payment / confirmation.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Quick Actions -->
        <div>
          <div class="actions-card">
            <h2>Quick actions</h2>
            <p class="actions-card-subtitle">
              Contact the traveler directly from this page.
            </p>

            <div class="action-buttons">
              <button id="btn-whatsapp" class="pill-btn-main primary" type="button" disabled>
                <span>üí¨</span>
                <span>WhatsApp traveler</span>
              </button>
              <button id="btn-email" class="pill-btn-main" type="button" disabled>
                <span>üìß</span>
                <span>Send email</span>
              </button>
              <button id="btn-invoice" class="pill-btn-main" type="button" disabled>
                <span>üìÑ</span>
                <span>Generate invoice</span>
              </button>
              <button id="btn-print" class="pill-btn-main" type="button" disabled>
                <span>üñ®Ô∏è</span>
                <span>Print details</span>
              </button>
            </div>

            <div id="actions-info" class="actions-info">
              Contact buttons will be enabled once booking data loads.
            </div>
          </div>

          <div class="actions-card" style="margin-top: 20px;">
            <h2>Status Update</h2>
            <p class="actions-card-subtitle">
              Update the booking status in Supabase (demo).
            </p>

            <div class="action-buttons">
              <button id="btn-status-confirm" class="pill-btn-main" type="button" style="background: rgba(34, 197, 94, 0.1); color: #15803d; border-color: rgba(34, 197, 94, 0.3);" disabled>
                <span>‚úì</span>
                <span>Mark as Confirmed</span>
              </button>
              <button id="btn-status-cancel" class="pill-btn-main" type="button" style="background: rgba(239, 68, 68, 0.1); color: #991b1b; border-color: rgba(239, 68, 68, 0.3);" disabled>
                <span>‚úï</span>
                <span>Mark as Cancelled</span>
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Back to top -->
  <button id="backToTop" class="back-to-top" aria-label="Back to top" title="Back to top">‚Üë</button>

  <!-- Footer -->
  <footer class="site-footer" role="contentinfo">
    <div class="container footer-grid">
      <div>
        <a class="logo footer-logo" href="index.html" aria-label="KPM Global Holidays Home">
          <img src="images/Logo-KPM Global  Holiday.png" alt="KPM Global Holidays Logo" class="logo-img" />
          KPM Global<span> Holidays</span>
        </a>
        <p class="footer-text">
          Internal booking view for KPM Global Holidays. Demo only, not for real bookings.
        </p>
      </div>
      <div>
        <h4>Admin</h4>
        <ul>
          <li><a href="admin.html#orders-admin">Back to orders</a></li>
          <li><a href="admin.html#stats-admin">Stats</a></li>
        </ul>
      </div>
      <div>
        <h4>Website</h4>
        <ul>
          <li><a href="index.html#packages">Holiday packages</a></li>
          <li><a href="index.html#destinations">Destinations</a></li>
        </ul>
      </div>
      <div>
        <h4>Account</h4>
        <ul>
          <li><a href="login.html">Login</a></li>
        </ul>
      </div>
    </div>
    <div class="container footer-bottom">
      <span>¬© <span id="footerYear"></span> KPM Global Holidays. Admin panel.</span>
      <span>Made for learning & demo purposes.</span>
    </div>
  </footer>

  <!-- Supabase + inline booking logic -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="script.js"></script>
  <script>
    const SUPABASE_URL = "https://hqpkihlwodmkymklyict.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhxcGtpaGx3b2Rta3lta2x5aWN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NTIwNTUsImV4cCI6MjA3OTUyODA1NX0.TzINeb5iOiahigBteOxxrGLxBCc1_hQGs6mRzSMeR5w";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function getBookingIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      return id ? parseInt(id, 10) : null;
    }

    function formatDate(dateStr) {
      if (!dateStr) return "-";
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      const opts = { day: "2-digit", month: "short", year: "numeric" };
      return d.toLocaleDateString("en-GB", opts);
    }

    function setStatusUI(status) {
      const pill = document.getElementById("meta-status-pill");
      const timelineStatus = document.getElementById("timeline-status");
      if (!pill || !timelineStatus) return;

      pill.classList.remove("status-new", "status-confirmed", "status-cancelled");

      const s = (status || "new").toLowerCase();
      if (s === "confirmed") {
        pill.classList.add("status-confirmed");
        pill.textContent = "Confirmed";
        timelineStatus.textContent = "Booking is confirmed. Share vouchers and final itinerary with traveler.";
      } else if (s === "cancelled") {
        pill.classList.add("status-cancelled");
        pill.textContent = "Cancelled";
        timelineStatus.textContent = "Booking has been cancelled. Inform traveler and process any refunds if needed.";
      } else {
        pill.classList.add("status-new");
        pill.textContent = "New";
        timelineStatus.textContent = "Awaiting admin review and confirmation.";
      }
    }

    async function loadBooking() {
      const id = getBookingIdFromUrl();
      const titleEl = document.getElementById("booking-title");
      const subtitleEl = document.getElementById("booking-subtitle");
      const idLabel = document.getElementById("booking-id-label");
      const actionsInfo = document.getElementById("actions-info");

      if (!id) {
        if (titleEl) titleEl.textContent = "Booking not found";
        if (subtitleEl) subtitleEl.textContent = "Missing booking ID in URL.";
        if (idLabel) idLabel.textContent = "Invalid ID";
        if (actionsInfo) actionsInfo.textContent = "No booking ID provided in URL.";
        return null;
      }

      if (idLabel) idLabel.textContent = `#${id}`;

      const { data, error } = await supabaseClient
        .from("bookings")
        .select("*")
        .eq("id", id)
        .maybeSingle();

      if (error || !data) {
        console.error("Error loading booking:", error);
        if (titleEl) titleEl.textContent = "Booking not found";
        if (subtitleEl) subtitleEl.textContent = "We could not load this booking. Please check Supabase or try again.";
        if (actionsInfo) actionsInfo.textContent = "Unable to load booking from Supabase. Check console for details.";
        return null;
      }

      const booking = data;

      // Title + subtitle
      const pkgName = booking.package_name || "Holiday enquiry";
      const travelerName = booking.full_name || "Guest";
      if (titleEl) titleEl.textContent = `Booking for ${travelerName}`;
      if (subtitleEl) {
        const checkIn = booking.start_date ? formatDate(booking.start_date) : "-";
        subtitleEl.textContent = `${pkgName} ‚Ä¢ Check-in: ${checkIn} ‚Ä¢ ID #${booking.id}`;
      }

      // Meta values
      document.getElementById("meta-package").textContent = pkgName;
      document.getElementById("meta-destination").textContent = booking.destination || booking.package_destination || "-";
      document.getElementById("meta-name").textContent = travelerName;
      document.getElementById("meta-email").textContent = booking.email || "-";
      document.getElementById("meta-phone").textContent = booking.phone || booking.whatsapp || "-";

      const start = booking.start_date ? formatDate(booking.start_date) : null;
      const end = booking.end_date ? formatDate(booking.end_date) : null;
      let dateLabel = "-";
      if (start && end) dateLabel = `${start} ‚Üí ${end}`;
      else if (start) dateLabel = start;
      document.getElementById("meta-dates").textContent = dateLabel;

      const adults = booking.adults || 0;
      const children = booking.children || 0;
      const guestLabel =
        adults || children
          ? `${adults} Adults${children ? `, ${children} Children` : ""}`
          : "-";
      document.getElementById("meta-guests").textContent = guestLabel;

      const createdAt = booking.created_at ? formatDate(booking.created_at) : "-";
      document.getElementById("meta-created").textContent = createdAt;
      document.getElementById("timeline-created").textContent =
        createdAt === "-" ? "Booking was received." : `Booking was received on ${createdAt}.`;

      document.getElementById("meta-preferences").textContent =
        booking.preferences || booking.special_requests || "No special requests added.";

      setStatusUI(booking.status);

      if (actionsInfo)
        actionsInfo.textContent =
          "Quick actions are now active. Use WhatsApp or email to contact the traveler.";

      return booking;
    }

    function enableQuickActions(booking) {
      const waBtn = document.getElementById("btn-whatsapp");
      const emailBtn = document.getElementById("btn-email");
      const invoiceBtn = document.getElementById("btn-invoice");
      const printBtn = document.getElementById("btn-print");
      const confirmBtn = document.getElementById("btn-status-confirm");
      const cancelBtn = document.getElementById("btn-status-cancel");

      const name = booking.full_name || "Guest";
      const email = booking.email || "";
      const phoneRaw = booking.phone || booking.whatsapp || "";
      const pkgName = booking.package_name || "Holiday enquiry";
      const checkIn = booking.start_date ? formatDate(booking.start_date) : "";
      const travellersText = `${booking.adults || 0} Adults${
        booking.children ? ", " + booking.children + " Children" : ""
      }`;

      // Normalize phone digits for wa.me
      const phoneDigits = phoneRaw.replace(/[^0-9]/g, "");

      // WhatsApp
      if (waBtn && phoneDigits) {
        waBtn.disabled = false;
        const waText = `Hi ${name}, this is KPM Global Holidays regarding your booking #${booking.id} for ${pkgName} (${checkIn}).`;
        const waUrl = `https://wa.me/${phoneDigits}?text=${encodeURIComponent(waText)}`;
        waBtn.addEventListener("click", () => {
          window.open(waUrl, "_blank");
        });
      }

      // Email
      if (emailBtn && email) {
        emailBtn.disabled = false;
        const subject = `Your KPM Global Holiday booking #${booking.id}`;
        const body = [
          `Hi ${name},`,
          "",
          `Thank you for your booking enquiry for "${pkgName}".`,
          `Travel dates: ${checkIn}`,
          `Travellers: ${travellersText}`,
          "",
          "Our team will shortly share the detailed itinerary and payment link.",
          "",
          "Warm regards,",
          "KPM Global Holidays",
        ].join("%0D%0A");

        const mailtoUrl = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(
          subject
        )}&body=${body}`;

        emailBtn.addEventListener("click", () => {
          window.location.href = mailtoUrl;
        });
      }

      // Invoice (uses localStorage and opens invoice.html)
      if (invoiceBtn) {
        invoiceBtn.disabled = false;
        invoiceBtn.addEventListener("click", () => {
          try {
            localStorage.setItem("bookingName", name);
            localStorage.setItem("bookingEmail", email || "");
            localStorage.setItem("bookingPhone", phoneRaw || "");
            localStorage.setItem("bookingPackage", pkgName);
            localStorage.setItem("bookingDate", checkIn || "");
            localStorage.setItem("bookingTravellers", travellersText || "");
            localStorage.setItem("bookingAmount", booking.amount || booking.price || "25000");
            localStorage.setItem("bookingGstPercent", "5");
          } catch (e) {
            console.warn("localStorage error (invoice):", e);
          }
          window.open("invoice.html", "_blank");
        });
      }

      // Print
      if (printBtn) {
        printBtn.disabled = false;
        printBtn.addEventListener("click", () => {
          window.print();
        });
      }

      // Status updates
      if (confirmBtn) confirmBtn.disabled = false;
      if (cancelBtn) cancelBtn.disabled = false;

      async function updateStatus(newStatus) {
        const { error } = await supabaseClient
          .from("bookings")
          .update({ status: newStatus })
          .eq("id", booking.id);

        const info = document.getElementById("actions-info");
        if (error) {
          console.error("Status update error:", error);
          if (info) info.textContent = "Status update failed. Check console for details.";
          return;
        }

        setStatusUI(newStatus);
        if (info) info.textContent = `Status updated to "${newStatus}".`;
      }

      if (confirmBtn) {
        confirmBtn.addEventListener("click", () => updateStatus("confirmed"));
      }
      if (cancelBtn) {
        cancelBtn.addEventListener("click", () => updateStatus("cancelled"));
      }
    }

    document.addEventListener("DOMContentLoaded", async function () {
      const yearSpan = document.getElementById("footerYear");
      if (yearSpan) yearSpan.textContent = new Date().getFullYear();

      const booking = await loadBooking();
      if (booking) {
        enableQuickActions(booking);
      }
    });
  </script>
</body>
</html>
